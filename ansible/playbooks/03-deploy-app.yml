---
- name: Deploy QR Forge Application
  hosts: qr_forge_servers
  become: yes
  vars:
    app_dir: /opt/qr-forge
    repo_url: "https://github.com/abdulazeez9/qr-forge.git"
  
  tasks:
    - name: Install git
      apt:
        name: git
        state: present

    - name: Create app directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Clone QR Forge repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_dir }}/app"
        version: main
        force: yes
      become_user: ubuntu

    - name: Create docker directory
      file:
        path: "{{ app_dir }}/docker"
        state: directory
        owner: ubuntu
        group: ubuntu

    - name: Create Dockerfile
      copy:
        content: |
          # Multi-stage Dockerfile for QR Forge React App
          FROM node:18-alpine AS build
          
          WORKDIR /app
          
          # Copy package files
          COPY app/package*.json ./
          
          # Install ALL dependencies (including dev deps like vite)
          RUN npm ci
          
          # Copy source code
          COPY app/ ./
          
          # Build the app
          RUN npm run build
          
          # Production stage
          FROM nginx:alpine
          
          # Copy nginx config
          COPY docker/nginx.conf /etc/nginx/conf.d/default.conf
          
          # Copy built app from build stage
          COPY --from=build /app/dist /usr/share/nginx/html
          
          # Expose port
          EXPOSE 80
          
          # Start nginx
          CMD ["nginx", "-g", "daemon off;"]
        dest: "{{ app_dir }}/docker/Dockerfile"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Create nginx.conf
      copy:
        content: |
          server {
              listen 80;
              server_name _;
              
              root /usr/share/nginx/html;
              index index.html;

              # Gzip compression
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;

              # Security headers
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-XSS-Protection "1; mode=block" always;
              add_header Referrer-Policy "no-referrer-when-downgrade" always;

              # PWA service worker
              location /sw.js {
                  add_header Cache-Control "no-cache";
                  proxy_cache_bypass $http_pragma;
                  proxy_cache_revalidate on;
                  expires off;
                  access_log off;
              }

              # Static assets caching
              location /assets/ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }

              # React Router support
              location / {
                  try_files $uri $uri/ /index.html;
              }

              # Health check endpoint
              location /health {
                  access_log off;
                  return 200 "healthy\n";
                  add_header Content-Type text/plain;
              }

              # Disable logging for favicon
              location = /favicon.ico {
                  log_not_found off;
                  access_log off;
              }
          }
        dest: "{{ app_dir }}/docker/nginx.conf"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Create docker-compose.yml
      copy:
        content: |
          services:
            qr-forge-app:
              build:
                context: .
                dockerfile: docker/Dockerfile
              container_name: qr-forge
              restart: unless-stopped
              ports:
                - "80:80"
              environment:
                - NODE_ENV=production
              networks:
                - qr-forge-network
              healthcheck:
                test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s
              labels:
                - "app=qr-forge"
                - "environment=production"

          networks:
            qr-forge-network:
              driver: bridge
        dest: "{{ app_dir }}/docker-compose.yml"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Verify docker-compose.yml was created
      stat:
        path: "{{ app_dir }}/docker-compose.yml"
      register: compose_file

    - name: Display file info
      debug:
        msg: "docker-compose.yml created: {{ compose_file.stat.exists }}, size: {{ compose_file.stat.size }} bytes"

    - name: Stop existing containers
      shell: docker compose down 2>/dev/null || true
      args:
        chdir: "{{ app_dir }}"
      become_user: ubuntu

    - name: Build and start Docker containers
      shell: docker compose up -d --build
      args:
        chdir: "{{ app_dir }}"
      become_user: ubuntu
      register: docker_result

    - name: Show Docker build output
      debug:
        var: docker_result.stdout_lines

    - name: Wait for containers to start
      pause:
        seconds: 20

    - name: Check container status
      command: docker ps
      register: docker_ps
      become_user: ubuntu
      changed_when: false

    - name: Display running containers
      debug:
        var: docker_ps.stdout_lines

    - name: Wait for application health check
      uri:
        url: "http://localhost:80/health"
        status_code: 200
      register: health_check
      until: health_check.status == 200
      retries: 15
      delay: 5

    - name: Deployment successful
      debug:
        msg: "âœ“ QR Forge deployed successfully! Application is running on port 80"

    - name: Get application URL
      debug:
        msg: "Access your app at: http://{{ ansible_host }}"
